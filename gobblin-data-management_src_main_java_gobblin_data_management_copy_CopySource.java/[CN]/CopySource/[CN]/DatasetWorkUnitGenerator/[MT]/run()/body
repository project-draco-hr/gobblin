{
  if (workUnitList.hasRejectedFileSet()) {
    return;
  }
  try {
    CopyConfiguration copyConfiguration=CopyConfiguration.builder(this.state.getProperties()).targetRoot(this.targetRoot).copyContext(this.copyContext).build();
    Collection<CopyableFile> files=this.copyableDataset.getCopyableFiles(this.targetFs,copyConfiguration);
    List<FileSet<CopyableFile>> fileSets=partitionCopyableFiles(this.copyableDataset,files);
    Collections.sort(fileSets,this.workUnitList.getComparator());
    for (    FileSet<CopyableFile> fileSet : fileSets) {
      Extract extract=new Extract(Extract.TableType.SNAPSHOT_ONLY,CopyConfiguration.COPY_PREFIX,fileSet.getName());
      List<WorkUnit> workUnitsForPartition=Lists.newArrayList();
      for (      CopyableFile copyableFile : fileSet.getFiles()) {
        CopyableDatasetMetadata metadata=new CopyableDatasetMetadata(this.copyableDataset,this.targetRoot);
        CopyableFile.DatasetAndPartition datasetAndPartition=copyableFile.getDatasetAndPartition(metadata);
        WorkUnit workUnit=new WorkUnit(extract);
        workUnit.addAll(this.state);
        serializeCopyableFile(workUnit,copyableFile);
        serializeCopyableDataset(workUnit,metadata);
        GobblinMetrics.addCustomTagToState(workUnit,new Tag<>(CopyEventSubmitterHelper.DATASET_ROOT_METADATA_NAME,this.copyableDataset.datasetRoot().toString()));
        workUnit.setProp(ConfigurationKeys.DATASET_URN_KEY,datasetAndPartition.toString());
        workUnit.setProp(SlaEventKeys.DATASET_URN_KEY,this.copyableDataset.datasetRoot());
        workUnit.setProp(SlaEventKeys.PARTITION_KEY,copyableFile.getFileSet());
        computeAndSetWorkUnitGuid(workUnit);
        workUnitsForPartition.add(workUnit);
      }
      this.workUnitList.addFileSet(fileSet,workUnitsForPartition);
    }
  }
 catch (  IOException ioe) {
    throw new RuntimeException("Failed to generate work units for dataset " + this.copyableDataset.datasetRoot(),ioe);
  }
}
