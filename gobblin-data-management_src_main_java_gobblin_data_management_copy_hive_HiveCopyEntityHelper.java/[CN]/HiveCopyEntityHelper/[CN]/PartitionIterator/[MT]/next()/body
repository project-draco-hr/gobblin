{
  if (this.partitionIterator.hasNext()) {
    Map.Entry<List<String>,Partition> partitionEntry=partitionIterator.next();
    List<CopyEntity> copyEntities=Lists.newArrayList();
    try {
      copyEntities=new PartitionCopy(partitionEntry.getValue(),dataset.properties).getCopyEntities();
    }
 catch (    IOException ioe) {
      log.error("Could not generate work units to copy partition " + partitionEntry.getValue().getCompleteName(),ioe);
    }
    targetPartitions.remove(partitionEntry.getKey());
    return new FileSet.Builder<>(partitionEntry.getValue().getCompleteName(),dataset).add(copyEntities).build();
  }
 else   if (!targetPartitions.isEmpty()) {
    List<CopyEntity> deregisterCopyEntities=Lists.newArrayList();
    int priority=1;
    String deregisterFileSet="deregister";
    for (    Map.Entry<List<String>,Partition> partitionEntry : targetPartitions.entrySet()) {
      try {
        priority=addDeregisterSteps(deregisterCopyEntities,deregisterFileSet,priority,targetTable,partitionEntry.getValue());
      }
 catch (      IOException ioe) {
        log.error("Could not create work unit to deregister partition " + partitionEntry.getValue().getCompleteName());
      }
    }
    targetPartitions.clear();
    return new FileSet.Builder<>(deregisterFileSet,dataset).add(deregisterCopyEntities).build();
  }
 else {
    throw new NoSuchElementException();
  }
}
