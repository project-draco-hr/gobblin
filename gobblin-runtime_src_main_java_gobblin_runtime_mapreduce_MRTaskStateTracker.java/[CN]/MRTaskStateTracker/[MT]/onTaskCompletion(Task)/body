{
  WorkUnit workUnit=task.getTaskState().getWorkunit();
  if (JobMetrics.isEnabled(workUnit)) {
    task.updateRecordMetrics();
    task.updateByteMetrics();
    JobMetrics metrics=JobMetrics.get(task.getTaskState().getProp(ConfigurationKeys.JOB_NAME_KEY),task.getJobId());
    if (workUnit.getPropAsBoolean(ConfigurationKeys.MR_INCLUDE_TASK_COUNTERS_KEY,ConfigurationKeys.DEFAULT_MR_INCLUDE_TASK_COUNTERS)) {
      Map<String,? extends Metric> taskLevelCounters=metrics.getMetricsOfType(JobMetrics.MetricType.COUNTER,JobMetrics.MetricGroup.TASK,task.getTaskId());
      for (      Map.Entry<String,? extends Metric> entry : taskLevelCounters.entrySet()) {
        this.context.getCounter(JobMetrics.MetricGroup.TASK.name(),entry.getKey()).setValue(((Counter)entry.getValue()).getCount());
      }
    }
    Map<String,? extends Metric> jobLevelCounters=metrics.getMetricsOfType(JobMetrics.MetricType.COUNTER,JobMetrics.MetricGroup.JOB,task.getJobId());
    for (    Map.Entry<String,? extends Metric> entry : jobLevelCounters.entrySet()) {
      this.context.getCounter(JobMetrics.MetricGroup.JOB.name(),entry.getKey()).increment(((Counter)entry.getValue()).getCount());
    }
  }
  task.markTaskCompletion();
  LOG.info(String.format("Task %s completed in %dms with state %s",task.getTaskId(),task.getTaskState().getTaskDuration(),task.getTaskState().getWorkingState()));
}
