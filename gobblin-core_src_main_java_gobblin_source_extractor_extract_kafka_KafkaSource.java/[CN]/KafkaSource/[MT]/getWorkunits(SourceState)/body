{
  Map<String,List<WorkUnit>> workUnits=Maps.newHashMap();
  Closer closer=Closer.create();
  try {
    KafkaWrapper kafkaWrapper=closer.register(KafkaWrapper.create(state));
    List<KafkaTopic> topics=getFilteredTopics(kafkaWrapper,state);
    for (    KafkaTopic topic : topics) {
      workUnits.put(topic.getName(),getWorkUnitsForTopic(kafkaWrapper,topic,state));
    }
    createEmptyWorkUnitsForSkippedPartitions(workUnits,state);
    int numOfMultiWorkunits=state.getPropAsInt(ConfigurationKeys.MR_JOB_MAX_MAPPERS_KEY,ConfigurationKeys.DEFAULT_MR_JOB_MAX_MAPPERS);
    this.getAllPreviousAvgSizes(state);
    return ImmutableList.copyOf(getMultiWorkunits(workUnits,numOfMultiWorkunits,state));
  }
  finally {
    try {
      closer.close();
    }
 catch (    IOException e) {
      LOG.error("Failed to close kafkaWrapper",e);
    }
  }
}
