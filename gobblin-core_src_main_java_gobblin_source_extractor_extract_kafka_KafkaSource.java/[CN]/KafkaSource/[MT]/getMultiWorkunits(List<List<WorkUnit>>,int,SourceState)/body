{
  Preconditions.checkArgument(numOfMultiWorkunits >= 1);
  long totalEstDataSize=0;
  for (  List<WorkUnit> workUnitsForTopic : workUnits) {
    for (    WorkUnit workUnit : workUnitsForTopic) {
      setWorkUnitEstSize(workUnit);
      totalEstDataSize+=getWorkUnitEstSize(workUnit);
    }
  }
  long avgGroupSize=(long)((double)totalEstDataSize / (double)numOfMultiWorkunits / 3.0);
  List<MultiWorkUnit> mwuGroups=Lists.newArrayList();
  for (  List<WorkUnit> workUnitsForTopic : workUnits) {
    long estimatedDataSizeForTopic=calcTotalEstSizeForTopic(workUnitsForTopic);
    if (estimatedDataSizeForTopic < avgGroupSize) {
      MultiWorkUnit mwuGroup=new MultiWorkUnit();
      addWorkUnitsToMultiWorkUnit(workUnitsForTopic,mwuGroup);
      mwuGroups.add(mwuGroup);
    }
 else {
      mwuGroups.addAll(bestFitDecreasingBinPacking(workUnitsForTopic,avgGroupSize));
    }
  }
  List<WorkUnit> groups=squeezeMultiWorkUnits(mwuGroups,state);
  return worstFitDecreasingBinPacking(groups,numOfMultiWorkunits);
}
