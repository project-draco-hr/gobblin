{
  Map<String,TaskConfig> taskConfigMap=Maps.newHashMap();
  Closer closer=Closer.create();
  try {
    ParallelRunner stateSerDeRunner=closer.register(new ParallelRunner(this.stateSerDeRunnerThreads,this.fs));
    for (    WorkUnit workUnit : workUnits) {
      addWorkUnit(workUnit,stateSerDeRunner,taskConfigMap);
    }
    Path jobStateFilePath=new Path(this.appWorkDir,this.jobContext.getJobId() + "." + JOB_STATE_FILE_NAME);
    SerializationUtils.serializeState(this.fs,jobStateFilePath,this.jobContext.getJobState());
  }
 catch (  Throwable t) {
    throw closer.rethrow(t);
  }
 finally {
    closer.close();
  }
  JobConfig.Builder jobConfigBuilder=new JobConfig.Builder();
  jobConfigBuilder.addTaskConfigMap(taskConfigMap).setCommand(GobblinWorkUnitRunner.GOBBLIN_TASK_FACTORY_NAME);
  return jobConfigBuilder;
}
