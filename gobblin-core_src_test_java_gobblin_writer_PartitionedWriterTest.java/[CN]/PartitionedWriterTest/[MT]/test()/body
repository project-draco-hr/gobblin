{
  State state=new State();
  state.setProp(ConfigurationKeys.WRITER_PARTITIONER_CLASS,TestPartitioner.class.getCanonicalName());
  TestPartitionAwareWriterBuilder builder=new TestPartitionAwareWriterBuilder();
  DataWriter<String> writer=new PartitionedDataWriter<String,String>(builder,state);
  Assert.assertEquals(builder.actions.size(),0);
  String record1="abc";
  writer.write(record1);
  Assert.assertEquals(builder.actions.size(),2);
  TestPartitionAwareWriterBuilder.Action action=builder.actions.poll();
  Assert.assertEquals(action.getPartition(),"a");
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.BUILD);
  action=builder.actions.poll();
  Assert.assertEquals(action.getPartition(),"a");
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.WRITE);
  Assert.assertEquals(action.getTarget(),record1);
  String record2="bcd";
  writer.write(record2);
  Assert.assertEquals(builder.actions.size(),2);
  action=builder.actions.poll();
  Assert.assertEquals(action.getPartition(),"b");
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.BUILD);
  action=builder.actions.poll();
  Assert.assertEquals(action.getPartition(),"b");
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.WRITE);
  Assert.assertEquals(action.getTarget(),record2);
  writer.write(record1);
  Assert.assertEquals(builder.actions.size(),1);
  action=builder.actions.poll();
  Assert.assertEquals(action.getPartition(),"a");
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.WRITE);
  Assert.assertEquals(action.getTarget(),record1);
  Assert.assertEquals(writer.recordsWritten(),3);
  Assert.assertEquals(writer.bytesWritten(),3);
  writer.cleanup();
  Assert.assertEquals(builder.actions.size(),2);
  action=builder.actions.poll();
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.CLEANUP);
  action=builder.actions.poll();
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.CLEANUP);
  writer.close();
  Assert.assertEquals(builder.actions.size(),2);
  action=builder.actions.poll();
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.CLOSE);
  action=builder.actions.poll();
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.CLOSE);
  writer.commit();
  Assert.assertEquals(builder.actions.size(),2);
  action=builder.actions.poll();
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.COMMIT);
  action=builder.actions.poll();
  Assert.assertEquals(action.getType(),TestPartitionAwareWriterBuilder.Actions.COMMIT);
}
