{
  String cleanupCommands=StringUtils.EMPTY;
  boolean isFirst=true;
  if (Iterables.tryFind(states,UNSUCCESSFUL_WORKUNIT).isPresent()) {
    for (    WorkUnitState wus : states) {
      if (isFirst) {
        cleanupCommands=HiveAvroORCQueryUtils.GSON.fromJson(wus.getProp(HiveAvroORCQueryUtils.SERIALIZED_CLEANUP_COMMANDS),String.class);
        isFirst=false;
      }
      wus.setWorkingState(WorkingState.FAILED);
      new SlaEventSubmitter(eventSubmitter,EventConstants.CONVERSION_FAILED_EVENT,wus.getProperties()).submit();
    }
  }
 else {
    String publishTableCommands=StringUtils.EMPTY;
    for (    WorkUnitState wus : states) {
      if (isFirst) {
        publishTableCommands=HiveAvroORCQueryUtils.GSON.fromJson(wus.getProp(HiveAvroORCQueryUtils.SERIALIZED_PUBLISH_TABLE_COMMANDS),String.class);
        executeQueries(publishTableCommands);
        cleanupCommands=HiveAvroORCQueryUtils.GSON.fromJson(wus.getProp(HiveAvroORCQueryUtils.SERIALIZED_CLEANUP_COMMANDS),String.class);
        isFirst=false;
      }
      String publishPartitionCommands=HiveAvroORCQueryUtils.GSON.fromJson(wus.getProp(HiveAvroORCQueryUtils.SERIALIZED_PUBLISH_PARTITION_COMMANDS),String.class);
      executeQueries(publishPartitionCommands);
      wus.setWorkingState(WorkingState.COMMITTED);
      wus.setActualHighWatermark(TableLevelWatermarker.GSON.fromJson(wus.getWorkunit().getExpectedHighWatermark(),LongWatermark.class));
      new SlaEventSubmitter(eventSubmitter,EventConstants.CONVERSION_SUCCESSFUL_SLA_EVENT,wus.getProperties()).submit();
    }
  }
  executeQueries(cleanupCommands);
}
