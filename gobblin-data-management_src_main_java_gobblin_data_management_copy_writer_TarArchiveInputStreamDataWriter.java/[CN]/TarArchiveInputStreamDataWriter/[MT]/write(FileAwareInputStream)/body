{
  this.closer.register(fileAwareInputStream.getInputStream());
  this.filesWritten.incrementAndGet();
  TarArchiveInputStream tarIn=new TarArchiveInputStream(fileAwareInputStream.getInputStream());
  final ReadableByteChannel inputChannel=Channels.newChannel(tarIn);
  TarArchiveEntry tarEntry;
  Path fileDestinationPath=fileAwareInputStream.getFile().getDestination();
  String tarEntryRootName=null;
  try {
    while ((tarEntry=tarIn.getNextTarEntry()) != null) {
      if (tarEntryRootName == null) {
        tarEntryRootName=StringUtils.remove(tarEntry.getName(),Path.SEPARATOR);
      }
      String newTarEntryPath=tarEntry.getName().replace(tarEntryRootName,fileDestinationPath.getName());
      Path tarEntryDestinationPath=PathUtils.withoutLeadingSeparator(new Path(fileDestinationPath.getParent(),newTarEntryPath));
      Path tarEntryStagingPath=new Path(this.stagingDir,tarEntryDestinationPath);
      log.info("Unarchiving at " + tarEntryStagingPath);
      if (tarEntry.isDirectory() && !this.fs.exists(tarEntryStagingPath)) {
        this.fs.mkdirs(tarEntryStagingPath);
      }
 else       if (!tarEntry.isDirectory()) {
        FSDataOutputStream out=this.fs.create(tarEntryStagingPath,true);
        final WritableByteChannel outputChannel=Channels.newChannel(out);
        try {
          this.bytesWritten.addAndGet(StreamUtils.copy(inputChannel,outputChannel));
        }
  finally {
          out.close();
          outputChannel.close();
        }
      }
    }
  }
  finally {
    tarIn.close();
    inputChannel.close();
    fileAwareInputStream.getInputStream().close();
  }
  this.setFilePermissions(fileAwareInputStream.getFile());
}
