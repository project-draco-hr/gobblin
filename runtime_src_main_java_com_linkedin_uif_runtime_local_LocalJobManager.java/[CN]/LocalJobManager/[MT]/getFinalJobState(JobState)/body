{
  jobState.setEndTime(System.currentTimeMillis());
  jobState.setDuration(jobState.getEndTime() - jobState.getStartTime());
  jobState.setState(JobState.RunningState.SUCCESSFUL);
  for (  TaskState taskState : jobState.getTaskStates()) {
    if (taskState.getWorkingState() == WorkUnitState.WorkingState.FAILED) {
      jobState.setState(JobState.RunningState.FAILED);
      break;
    }
    if (taskState.getWorkingState() == WorkUnitState.WorkingState.ABORTED) {
      jobState.setState(JobState.RunningState.ABORTED);
      break;
    }
  }
  if (jobState.getState() != JobState.RunningState.SUCCESSFUL) {
    try {
      StringWriter stringWriter=new StringWriter();
      JsonWriter jsonWriter=new JsonWriter(stringWriter);
      jsonWriter.setIndent("\t");
      jobState.toJson(jsonWriter);
      EmailUtils.sendJobFailureAlertEmail(jobState.getJobName(),stringWriter.toString(),jobState);
    }
 catch (    Throwable t) {
      LOG.error("Failed to construct and send job failure alert email for job " + jobState.getJobId(),t);
    }
  }
  return jobState;
}
