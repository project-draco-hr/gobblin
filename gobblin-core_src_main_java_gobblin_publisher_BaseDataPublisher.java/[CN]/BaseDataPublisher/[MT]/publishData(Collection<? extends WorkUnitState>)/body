{
  Set<Path> writerOutputPathsMoved=Sets.newHashSet();
  for (  WorkUnitState workUnitState : states) {
    for (int i=0; i < this.branches; i++) {
      String writerFilePathKey=ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.WRITER_FILE_PATH,this.branches,i);
      if (!workUnitState.contains(writerFilePathKey)) {
        continue;
      }
      Path writerOutputDir=new Path(workUnitState.getProp(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.WRITER_OUTPUT_DIR,this.branches,i)),workUnitState.getProp(writerFilePathKey));
      Path publisherOutputDir=new Path(workUnitState.getProp(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.DATA_PUBLISHER_FINAL_DIR,this.branches,i)),workUnitState.getProp(writerFilePathKey));
      if (writerOutputPathsMoved.contains(writerOutputDir)) {
        continue;
      }
      if (this.fss.get(i).exists(publisherOutputDir)) {
        boolean replaceFinalOutputDir=this.getState().getPropAsBoolean(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.DATA_PUBLISHER_REPLACE_FINAL_DIR,branches,i));
        if (!replaceFinalOutputDir) {
          boolean preserveFileName=workUnitState.getPropAsBoolean(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.SOURCE_FILEBASED_PRESERVE_FILE_NAME,branches,i),false);
          for (          FileStatus status : this.fss.get(i).listStatus(writerOutputDir)) {
            Path finalOutputPath=preserveFileName ? new Path(publisherOutputDir,workUnitState.getProp(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.DATA_PUBLISHER_FINAL_NAME,branches,i))) : new Path(publisherOutputDir,status.getPath().getName());
            if (this.fss.get(i).rename(status.getPath(),finalOutputPath)) {
              LOG.info(String.format("Moved %s to %s",status.getPath(),finalOutputPath));
            }
 else {
              throw new IOException("Failed to move file from " + status.getPath() + " to "+ finalOutputPath);
            }
          }
          writerOutputPathsMoved.add(writerOutputDir);
          continue;
        }
        this.fss.get(i).delete(publisherOutputDir,true);
      }
 else {
        this.fss.get(i).mkdirs(publisherOutputDir.getParent());
      }
      if (this.fss.get(i).exists(writerOutputDir)) {
        if (this.fss.get(i).rename(writerOutputDir,publisherOutputDir)) {
          LOG.info(String.format("Moved %s to %s",writerOutputDir,publisherOutputDir));
          writerOutputPathsMoved.add(writerOutputDir);
        }
 else {
          throw new IOException("Failed to move from " + writerOutputDir + " to "+ publisherOutputDir);
        }
      }
 else {
        LOG.warn("WorkUnit " + workUnitState.getId() + " produced no data");
      }
    }
    workUnitState.setWorkingState(WorkUnitState.WorkingState.COMMITTED);
  }
}
