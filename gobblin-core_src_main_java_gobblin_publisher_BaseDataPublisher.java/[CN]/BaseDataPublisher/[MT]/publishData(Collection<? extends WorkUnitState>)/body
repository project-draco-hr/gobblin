{
  Set<Path> writerOutputPathMoved=Sets.newHashSet();
  for (  WorkUnitState workUnitState : states) {
    int branches=workUnitState.getPropAsInt(ConfigurationKeys.FORK_BRANCHES_KEY,1);
    for (int i=0; i < branches; i++) {
      Path writerOutput=WriterUtils.getWriterOutputDir(workUnitState,branches > 1 ? i : -1);
      Path publisherOutput=WriterUtils.getDataPublisherFinalOutputDir(workUnitState,branches > 1 ? i : -1);
      if (writerOutputPathMoved.contains(writerOutput)) {
        continue;
      }
      if (!this.fss.get(i).exists(publisherOutput.getParent())) {
        this.fss.get(i).mkdirs(publisherOutput.getParent());
      }
      if (this.fss.get(i).exists(publisherOutput)) {
        boolean replaceFinalOutputDir=this.getState().getPropAsBoolean(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.DATA_PUBLISHER_REPLACE_FINAL_DIR,branches,i));
        if (!replaceFinalOutputDir) {
          boolean preserveFileName=workUnitState.getPropAsBoolean(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.SOURCE_FILEBASED_PRESERVE_FILE_NAME,branches,i),false);
          for (          FileStatus status : this.fss.get(i).listStatus(writerOutput)) {
            Path outputPath=preserveFileName ? new Path(publisherOutput,workUnitState.getProp(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.DATA_PUBLISHER_FINAL_NAME,branches,i))) : new Path(publisherOutput,status.getPath().getName());
            if (this.fss.get(i).rename(status.getPath(),outputPath)) {
              LOG.info(String.format("Moved %s to %s",status.getPath(),outputPath));
            }
 else {
              throw new IOException("Failed to move from " + status.getPath() + " to "+ outputPath);
            }
          }
          writerOutputPathMoved.add(writerOutput);
          continue;
        }
        this.fss.get(i).delete(publisherOutput,true);
      }
      if (this.fss.get(i).exists(writerOutput)) {
        if (this.fss.get(i).rename(writerOutput,publisherOutput)) {
          LOG.info(String.format("Moved %s to %s",writerOutput,publisherOutput));
          writerOutputPathMoved.add(writerOutput);
        }
 else {
          throw new IOException("Failed to move from " + writerOutput + " to "+ publisherOutput);
        }
      }
    }
    workUnitState.setWorkingState(WorkUnitState.WorkingState.COMMITTED);
  }
}
