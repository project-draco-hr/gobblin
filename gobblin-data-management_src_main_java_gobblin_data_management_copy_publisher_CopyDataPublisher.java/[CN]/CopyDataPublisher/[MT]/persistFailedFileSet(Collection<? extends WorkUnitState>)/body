{
  RecoveryHelper recoveryHelper=new RecoveryHelper(this.fs,this.state);
  int filesPersisted=0;
  for (  WorkUnitState wu : workUnitStates) {
    if (wu.getWorkingState() == WorkingState.SUCCESSFUL) {
      CopyableFile file=CopySource.deserializeCopyableFile(wu);
      Path outputDir=FileAwareInputStreamDataWriter.getOutputDir(wu);
      CopyableDatasetMetadata metadata=CopySource.deserializeCopyableDataset(wu);
      Path outputPath=FileAwareInputStreamDataWriter.getOutputFilePath(file,outputDir,file.getDatasetAndPartition(metadata));
      if (recoveryHelper.persistFile(wu,file,outputPath)) {
        filesPersisted++;
      }
    }
  }
  return filesPersisted;
}
