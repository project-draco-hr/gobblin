{
  try (Connection conn=createConnection()){
    JobCommitPolicy jobCommitPolicy=JobCommitPolicy.getCommitPolicy(state);
    boolean isSkipStaging=!JobCommitPolicy.COMMIT_ON_FULL_SUCCESS.equals(jobCommitPolicy);
    if (isSkipStaging) {
      LOG.info("Writer will write directly to destination table as JobCommitPolicy is " + jobCommitPolicy);
    }
    int branches=state.getPropAsInt(ConfigurationKeys.FORK_BRANCHES_KEY,1);
    final String publishTable=getProp(state,ConfigurationKeys.JDBC_PUBLISHER_FINAL_TABLE_NAME,branches,branchId);
    final String stagingTableKey=ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.WRITER_STAGING_TABLE,branches,branchId);
    userCreatedStagingTable=state.getProp(stagingTableKey);
    int i=-1;
    for (    WorkUnit wu : workUnits) {
      i++;
      if (isSkipStaging) {
        LOG.info("User chose to skip staing table on branch " + branchId + " workunit "+ i);
        wu.setProp(stagingTableKey,publishTable);
        if (i == 0) {
          if (getPropAsBoolean(state,ConfigurationKeys.JDBC_PUBLISHER_REPLACE_FINAL_TABLE,branches,branchId)) {
            LOG.info("User chose to replace final table " + publishTable + " on branch "+ branchId+ " workunit "+ i);
            commands.truncate(conn,publishTable);
          }
        }
        continue;
      }
      if (!StringUtils.isEmpty(userCreatedStagingTable)) {
        LOG.info("Staging table for branch " + branchId + " from user: "+ userCreatedStagingTable);
        wu.setProp(stagingTableKey,userCreatedStagingTable);
        if (i == 0) {
          if (state.getPropAsBoolean(ForkOperatorUtils.getPropertyNameForBranch(ConfigurationKeys.WRITER_TRUNCATE_STAGING_TABLE,branches,branchId),false)) {
            LOG.info("Truncating staging table " + userCreatedStagingTable + " as requested.");
            commands.truncate(conn,userCreatedStagingTable);
          }
          if (!commands.isEmpty(conn,userCreatedStagingTable)) {
            LOG.error("Staging table " + userCreatedStagingTable + " is not empty. Failing.");
            throw new IllegalArgumentException("Staging table " + userCreatedStagingTable + " should be empty.");
          }
        }
        continue;
      }
      LOG.info("Staging table has not been passed from user for branch " + branchId + " workunit "+ i+ " . Creating.");
      String stagingTable=createStagingTable(conn);
      wu.setProp(stagingTableKey,stagingTable);
      createdStagingTables.add(stagingTable);
      LOG.info("Staging table " + stagingTable + " has been created for branchId "+ branchId+ " workunit "+ i);
    }
  }
 catch (  SQLException e) {
    throw new RuntimeException("Failed with SQL",e);
  }
}
