{
  Extractor extractor=null;
  DataWriter writer=null;
  try {
    extractor=this.taskContext.getSource().getExtractor(this.taskState);
    boolean doConversion=!this.taskContext.getConverters().isEmpty();
    Object sourceSchema=extractor.getSchema();
    Converter converter=null;
    Object schemaForWriter=sourceSchema;
    if (doConversion) {
      converter=new MultiConverter(this.taskContext.getConverters());
      schemaForWriter=converter.convertSchema(sourceSchema,this.taskState.getWorkunit());
    }
    writer=buildWriter(this.taskContext,schemaForWriter);
    this.taskState.setWorkingState(WorkUnitState.WorkingState.WORKING);
    this.taskStateTracker.registerNewTask(this);
    Object record;
    while ((record=extractor.readRecord()) != null) {
      if (doConversion) {
        record=converter.convertRecord(sourceSchema,record,this.taskState.getWorkunit());
      }
      writer.write(record);
    }
    this.taskState.setWorkingState(WorkUnitState.WorkingState.COMMITTED);
  }
 catch (  IOException ioe) {
    LOG.error(String.format("Task %s failed",this.taskId),ioe);
    this.taskState.setWorkingState(WorkUnitState.WorkingState.FAILED);
  }
 finally {
    if (extractor != null) {
      try {
        extractor.close();
      }
 catch (      Exception ioe) {
      }
    }
    if (writer != null) {
      try {
        writer.close();
      }
 catch (      IOException ioe) {
      }
    }
    this.taskStateTracker.onTaskCompletion(this);
  }
}
