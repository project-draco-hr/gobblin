{
  Extractor extractor=this.taskContext.getSource().getExtractor(this.taskState);
  Converter converter=new MultiConverter(this.taskContext.getConverters());
  Object schemaForWriter=converter.convertSchema(extractor.getSchema(),this.taskState.getWorkunit());
  DataWriter writer;
  try {
    writer=buildWriter(this.taskContext,schemaForWriter);
  }
 catch (  IOException ioe) {
    LOG.error("Failed to build the writer",ioe);
    this.taskState.setWorkingState(WorkUnitState.WorkingState.FAILED);
    return;
  }
 finally {
    extractor.close();
  }
  this.taskState.setWorkingState(WorkUnitState.WorkingState.WORKING);
  try {
    Object record;
    while ((record=extractor.readRecord()) != null) {
      Object convertedRecord=converter.convertRecord(schemaForWriter,record,this.taskState.getWorkunit());
      writer.write(convertedRecord);
    }
    this.taskState.setProp(ConfigurationKeys.QUALITY_CHECKER_PREFIX + ConfigurationKeys.EXTRACTOR_ROWS_READ,extractor.getExpectedRecordCount());
    this.taskState.setProp(ConfigurationKeys.QUALITY_CHECKER_PREFIX + ConfigurationKeys.WRITER_ROWS_WRITTEN,writer.recordsWritten());
    MetaStoreClient collector=buildMetaStoreClient(this.taskState);
    PolicyChecker policyChecker=buildPolicyChecker(this.taskState,collector);
    PolicyCheckResults results=policyChecker.executePolicies();
    TaskPublisher publisher=buildTaskPublisher(this.taskState,results,collector);
switch (publisher.publish()) {
case SUCCESS:
      this.taskState.setWorkingState(WorkUnitState.WorkingState.COMMITTED);
    break;
default :
  this.taskState.setWorkingState(WorkUnitState.WorkingState.FAILED);
break;
}
}
 catch (Exception e) {
LOG.error(String.format("Task %s failed",this.toString()),e);
this.taskState.setWorkingState(WorkUnitState.WorkingState.FAILED);
}
 finally {
try {
extractor.close();
}
 catch (Exception ioe) {
}
try {
writer.close();
}
 catch (IOException ioe) {
}
this.statusReportingTimer.cancel();
try {
this.taskManager.getTaskTracker().reportTaskState(this.taskState);
}
 catch (IOException ioe) {
LOG.error("Failed to report task state for task " + this.taskId);
}
}
}
