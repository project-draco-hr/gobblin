{
  BufferedWriter scriptWriter=null;
  Closer closer=Closer.create();
  try {
    if (fs.exists(dumpScript)) {
      LOG.info("Heap dump script already exists: " + dumpScript);
    }
 else {
      String dumpDir=dumpScript.getParent() + DUMP_FOLDER;
      scriptWriter=closer.register(new BufferedWriter(new OutputStreamWriter(fs.create(dumpScript))));
      scriptWriter.write("#!/bin/sh\n" + "hadoop dfs -put " + heapFileName + " "+ dumpDir+ "${PWD//\\//_}.hprof");
      scriptWriter.flush();
      Runtime.getRuntime().exec(chmod + " " + dumpScript);
      if (!fs.exists(new Path(dumpScript.getParent() + DUMP_FOLDER))) {
        fs.mkdirs(new Path(dumpDir));
      }
    }
  }
 catch (  IOException e) {
    LOG.error("Heap dump script is not generated successfully.");
    if (fs.exists(dumpScript)) {
      fs.delete(dumpScript,true);
    }
  }
 finally {
    closer.close();
  }
}
