{
  byte[] payload=getBytes(messageAndOffset.message().payload());
  if (payload[0] != KafkaAvroSchemaRegistry.MAGIC_BYTE) {
    throw new RuntimeException(String.format("Unknown magic byte for partition %s",this.getCurrentPartition()));
  }
  byte[] schemaIdByteArray=Arrays.copyOfRange(payload,1,1 + KafkaAvroSchemaRegistry.SCHEMA_ID_LENGTH_BYTE);
  String schemaId=Hex.encodeHexString(schemaIdByteArray);
  Schema schema=null;
  schema=this.schemaRegistry.getSchemaById(schemaId);
  reader.get().setSchema(schema);
  Decoder binaryDecoder=DecoderFactory.get().binaryDecoder(payload,1 + KafkaAvroSchemaRegistry.SCHEMA_ID_LENGTH_BYTE,payload.length - 1 - KafkaAvroSchemaRegistry.SCHEMA_ID_LENGTH_BYTE,null);
  try {
    GenericRecord record=reader.get().read(null,binaryDecoder);
    record=AvroUtils.convertRecordSchema(record,this.schema.get());
    return record;
  }
 catch (  IOException e) {
    LOG.error(String.format("Error during decoding record for partition %s: ",this.getCurrentPartition()));
    throw e;
  }
}
