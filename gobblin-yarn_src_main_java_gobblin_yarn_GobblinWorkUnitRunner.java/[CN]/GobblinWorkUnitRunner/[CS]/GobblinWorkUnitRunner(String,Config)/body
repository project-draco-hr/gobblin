{
  this.containerId=ConverterUtils.toContainerId(System.getenv().get(ApplicationConstants.Environment.CONTAINER_ID.key()));
  FileSystem fs=FileSystem.get(new Configuration());
  String zkConnectionString=config.getString(ConfigurationConstants.ZK_CONNECTION_STRING_KEY);
  this.helixManager=HelixManagerFactory.getZKHelixManager(config.hasPath(ConfigurationConstants.HELIX_CLUSTER_NAME_KEY) ? config.getString(ConfigurationConstants.HELIX_CLUSTER_NAME_KEY) : applicationName,YarnHelixUtils.getParticipantIdStr(YarnHelixUtils.getHostname(),this.containerId),InstanceType.PARTICIPANT,zkConnectionString);
  this.helixManager.addMessageListener(new GobblinParticipantMessageListener(),YarnHelixUtils.getParticipantIdStr(YarnHelixUtils.getHostname(),this.containerId));
  Properties properties=YarnHelixUtils.configToProperties(config);
  TaskExecutor taskExecutor=new TaskExecutor(properties);
  TaskStateTracker taskStateTracker=new GobblinHelixTaskStateTracker(properties,this.helixManager);
  List<Service> services=Lists.newArrayList();
  if (UserGroupInformation.isSecurityEnabled()) {
    services.add(new ParticipantSecurityManager(config,fs));
  }
  services.add(taskExecutor);
  services.add(taskStateTracker);
  this.serviceManager=new ServiceManager(services);
  StateMachineEngine stateMachineEngine=this.helixManager.getStateMachineEngine();
  Map<String,TaskFactory> taskFactoryMap=Maps.newHashMap();
  Path appWorkDir=YarnHelixUtils.getAppWorkDirPath(fs,applicationName,containerId.getApplicationAttemptId().getApplicationId());
  taskFactoryMap.put(GOBBLIN_TASK_FACTORY_NAME,new GobblinHelixTaskFactory(taskExecutor,taskStateTracker,fs,appWorkDir));
  stateMachineEngine.registerStateModelFactory(StateModelDefId.from("Task"),new TaskStateModelFactory(this.helixManager,taskFactoryMap));
}
