{
  String privateKey=PasswordManager.getInstance(state).readPassword(state.getProp(ConfigurationKeys.SOURCE_CONN_PRIVATE_KEY));
  String password=PasswordManager.getInstance(state).readPassword(state.getProp(ConfigurationKeys.SOURCE_CONN_PASSWORD));
  String knownHosts=state.getProp(ConfigurationKeys.SOURCE_CONN_KNOWN_HOSTS);
  String userName=state.getProp(ConfigurationKeys.SOURCE_CONN_USERNAME);
  String hostName=state.getProp(ConfigurationKeys.SOURCE_CONN_HOST_NAME);
  int port=state.getPropAsInt(ConfigurationKeys.SOURCE_CONN_PORT,ConfigurationKeys.SOURCE_CONN_DEFAULT_PORT);
  String proxyHost=state.getProp(ConfigurationKeys.SOURCE_CONN_USE_PROXY_URL);
  int proxyPort=state.getPropAsInt(ConfigurationKeys.SOURCE_CONN_USE_PROXY_PORT,-1);
  JSch.setLogger(new JSchLogger());
  JSch jsch=new JSch();
  log.info("Attempting to connect to source via SFTP with" + " privateKey: " + privateKey + " knownHosts: "+ knownHosts+ " userName: "+ userName+ " hostName: "+ hostName+ " port: "+ port+ " proxyHost: "+ proxyHost+ " proxyPort: "+ proxyPort);
  try {
    if (!Strings.isNullOrEmpty(privateKey)) {
      List<IdentityStrategy> identityStrategies=ImmutableList.of(new LocalFileIdentityStrategy(),new DistributedCacheIdentityStrategy(),new HDFSIdentityStrategy());
      for (      IdentityStrategy identityStrategy : identityStrategies) {
        if (identityStrategy.setIdentity(privateKey,jsch)) {
          break;
        }
      }
    }
    session=jsch.getSession(userName,hostName,port);
    session.setConfig("PreferredAuthentications","publickey,password");
    if (Strings.isNullOrEmpty(knownHosts)) {
      log.info("Known hosts path is not set, StrictHostKeyChecking will be turned off");
      session.setConfig("StrictHostKeyChecking","no");
    }
 else {
      jsch.setKnownHosts(knownHosts);
    }
    if (!Strings.isNullOrEmpty(password)) {
      session.setPassword(password);
    }
    if (proxyHost != null && proxyPort >= 0) {
      session.setProxy(new ProxyHTTP(proxyHost,proxyPort));
    }
    UserInfo ui=new MyUserInfo();
    session.setUserInfo(ui);
    session.setDaemonThread(true);
    session.connect();
    log.info("Finished connecting to source");
  }
 catch (  JSchException e) {
    if (session != null) {
      session.disconnect();
    }
    log.error(e.getMessage(),e);
    throw new FileBasedHelperException("Cannot connect to SFTP source",e);
  }
}
